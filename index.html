<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Diet Plan">
    <title>Diet Plan</title>
    <!-- Add Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Add Canvas Confetti Library -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            /* Apple Fitness Palette */
            --bg-color: #000000;
            
            /* Liquid Glass Variables */
            --glass-bg: rgba(28, 28, 30, 0.65);
            --glass-border: rgba(255, 255, 255, 0.12);
            --glass-highlight: rgba(255, 255, 255, 0.05);
            --glass-blur: 25px;
            
            --text-primary: #ffffff;
            --text-secondary: #8e8e93;
            --divider: rgba(255, 255, 255, 0.1);
            --nav-bg: rgba(20, 20, 20, 0.85);
            
            /* Neon Accents */
            --fitness-red: #fa114f;    /* Calories/Move */
            --fitness-green: #a4ff00;  /* Exercise/Protein */
            --fitness-cyan: #00e0ff;   /* Stand/Fasting */
            --fitness-orange: #ff9500; /* Warm accent */
            
            --radius-lg: 24px; /* More rounded for liquid feel */
            --radius-sm: 12px;
            --bottom-nav-height: 110px; /* Increased to account for floating space */
        }

        /* GLOBAL RESET */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { overflow-x: hidden; background-color: var(--bg-color); }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Rounded", "SF Pro Display", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            overscroll-behavior-y: none;
            overflow-x: hidden;
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Ambient Background Light (Creates the Liquid effect) */
        body::before {
            content: '';
            position: fixed;
            top: -20%;
            left: -20%;
            width: 140%;
            height: 80%;
            background: radial-gradient(circle at 50% 0%, rgba(30, 30, 35, 1) 0%, rgba(0,0,0,0) 70%);
            z-index: -1;
            pointer-events: none;
        }

        /* HIDE SCROLLBARS (Native iOS Feel) */
        ::-webkit-scrollbar { display: none; }

        /* SCROLLABLE CONTENT AREA */
        .app-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            padding-top: max(10px, env(safe-area-inset-top));
            /* Add padding for bottom nav */
            padding-bottom: calc(var(--bottom-nav-height) + env(safe-area-inset-bottom));
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }

        /* TAB VIEWS */
        .view-section {
            display: none;
            animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .view-section.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }

        /* HEADER */
        header { padding: 10px 10px 20px 10px; text-align: left; }
        h1 { 
            margin: 0; font-size: 34px; font-weight: 800; letter-spacing: 0.3px; line-height: 1.1; 
            background: linear-gradient(180deg, #fff, #ccc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        h2 { margin-top: 5px; font-weight: 600; font-size: 13px; color: var(--fitness-red); text-transform: uppercase; letter-spacing: -0.2px; }

        /* COMMON GLASS CARD STYLE */
        .glass-panel {
            background-color: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            box-shadow: 0 4px 24px rgba(0,0,0,0.2);
            transition: transform 0.2s, background-color 0.2s;
        }

        /* SUMMARY GRID */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 30px;
            width: 100%;
            padding: 0 5px;
        }

        .stat-card {
            padding: 15px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 90px;
            background: linear-gradient(145deg, rgba(40,40,44,0.7), rgba(20,20,22,0.7));
        }

        .stat-value { font-size: 1.6rem; font-weight: 700; font-family: "SF Pro Rounded", system-ui, sans-serif; letter-spacing: 0.5px; filter: drop-shadow(0 0 8px rgba(255,255,255,0.15)); }
        .stat-label { font-size: 0.85rem; color: var(--text-secondary); font-weight: 600; margin-top: 4px; }

        /* SECTION TITLES */
        .section-title {
            font-size: 1.35rem;
            font-weight: 700;
            margin-bottom: 12px;
            margin-top: 30px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            padding-left: 10px;
            letter-spacing: 0.3px;
            opacity: 0.9;
        }

        /* INFO CARDS */
        .protocol-grid { display: grid; grid-template-columns: 1fr; gap: 15px; padding: 0 5px; }
        @media (min-width: 600px) { .protocol-grid { grid-template-columns: 1fr 1fr; } }

        .info-card {
            padding: 20px;
            background: var(--glass-bg);
        }
        .info-card h4 { margin: 0 0 8px 0; color: var(--fitness-cyan); font-size: 1rem; }
        .info-card p { font-size: 0.95rem; color: var(--text-secondary); margin-bottom: 8px; line-height: 1.4; }
        .info-card strong { color: var(--text-primary); }

        /* MEAL PLAN */
        .days-container { display: grid; gap: 12px; padding: 0 5px; }
        .day-card { 
            padding: 18px; 
            cursor: pointer; 
            position: relative;
        }
        .day-card:active { transform: scale(0.98); background-color: rgba(60, 60, 65, 0.6); }
        
        .day-card::after {
            content: '‚Ä∫';
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.4rem;
            color: rgba(255,255,255,0.3);
            font-weight: 600;
            line-height: 1;
        }

        .day-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 12px; padding-bottom: 12px; border-bottom: 0.5px solid var(--divider);
            padding-right: 25px; 
        }
        .day-name { font-size: 1.1rem; font-weight: 700; color: var(--text-primary); text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        
        /* Stats row in header */
        .day-stats { display: flex; gap: 8px; }
        .stat-badge { font-size: 0.75rem; font-weight: 600; padding: 3px 8px; border-radius: 6px; letter-spacing: 0.3px; backdrop-filter: blur(4px); }
        .stat-cals { color: var(--fitness-red); background: rgba(250, 17, 79, 0.15); border: 1px solid rgba(250, 17, 79, 0.2); }
        .stat-prot { color: var(--fitness-green); background: rgba(164, 255, 0, 0.15); border: 1px solid rgba(164, 255, 0, 0.2); }
        
        .meal-row { margin-bottom: 15px; padding-left: 0; }
        .meal-row:last-child { margin-bottom: 0; }
        .meal-title { font-size: 0.75rem; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 4px; font-weight: 600; letter-spacing: 0.5px; opacity: 0.8; }
        .meal-content { font-size: 1rem; color: var(--text-primary); margin-bottom: 6px; line-height: 1.3; }

        /* BADGES */
        .badges-wrapper { display: flex; gap: 6px; flex-wrap: wrap; }
        .badge { font-size: 0.7rem; padding: 3px 8px; border-radius: 6px; font-weight: 600; display: inline-block; backdrop-filter: blur(5px); }
        .badge-protein { color: #000; background-color: var(--fitness-green); box-shadow: 0 0 10px rgba(164, 255, 0, 0.3); }
        .badge-millet { color: #000; background-color: var(--fitness-orange); }
        .badge-info { color: var(--fitness-cyan); background-color: rgba(0, 224, 255, 0.15); border: 1px solid rgba(0, 224, 255, 0.2); }
        .badge-cal { color: var(--fitness-red); border: 1px solid rgba(250, 17, 79, 0.3); background: rgba(250, 17, 79, 0.05); }

        /* FULL SCREEN MODAL (SHEET STYLE) */
        .day-modal {
            position: fixed;
            top: 0; left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.6); /* Dim background */
            backdrop-filter: blur(15px);
            z-index: 2000;
            display: none;
            flex-direction: column;
            justify-content: flex-end; /* Sheet coming from bottom */
            animation: fadeInModal 0.2s ease;
        }
        .day-modal.active { display: flex; }
        @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }

        /* The actual sheet card */
        .modal-sheet {
            background: #121212;
            width: 100%;
            height: 92vh;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            padding: 0 20px 20px 20px;
            overflow-y: auto;
            position: relative;
            animation: slideUpSheet 0.35s cubic-bezier(0.19, 1, 0.22, 1);
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
            border-top: 1px solid var(--glass-border);
        }
        @keyframes slideUpSheet { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* Modal Handle */
        .modal-handle-container {
            width: 100%;
            display: flex;
            justify-content: center;
            padding-top: 15px;
            padding-bottom: 25px;
            position: sticky;
            top: 0;
            background: #121212;
            z-index: 10;
        }
        .modal-handle {
            width: 36px;
            height: 5px;
            background-color: #3a3a3c;
            border-radius: 3px;
        }

        .modal-header-bar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; border-bottom: 0.5px solid var(--divider); padding-bottom: 20px;
            flex-shrink: 0;
        }
        .modal-day-title { font-size: 2.2rem; font-weight: 800; color: white; letter-spacing: -0.5px; }
        .modal-close-btn {
            background: #2c2c2e; color: #8e8e93; border: none;
            width: 32px; height: 32px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 1rem; cursor: pointer; font-weight: 700;
        }

        .modal-body-content { padding-bottom: 80px; }
        .modal-meal-row { margin-bottom: 40px; }
        .modal-meal-type { font-size: 0.9rem; color: var(--fitness-orange); text-transform: uppercase; font-weight: 700; margin-bottom: 8px; letter-spacing: 1px; }
        .modal-meal-desc { font-size: 1.5rem; line-height: 1.3; color: white; margin-bottom: 15px; font-weight: 600; font-family: "SF Pro Rounded"; }
        .modal-badges-wrapper { transform: scale(1.1); transform-origin: left; }

        /* WALKING TOOL */
        .walking-tool-card {
            padding: 40px 20px;
            display: flex; flex-direction: column; align-items: center;
            margin-top: 10px;
            position: relative;
            overflow: hidden;
            margin-left: 5px; margin-right: 5px;
            background: linear-gradient(180deg, rgba(30,30,35,0.7), rgba(15,15,18,0.7));
        }

        .ring-container {
            position: relative;
            width: 260px;
            height: 260px;
            margin-bottom: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .progress-ring__circle-bg { stroke: rgba(255,255,255,0.05); }
        .progress-ring__circle {
            stroke: var(--fitness-green);
            stroke-linecap: round;
            transition: stroke-dashoffset 0.35s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            filter: drop-shadow(0 0 8px rgba(164, 255, 0, 0.5)); /* Stronger neon glow */
        }

        .timer-value-container { position: absolute; text-align: center; }
        .timer-display {
            font-size: 3.8rem;
            font-weight: 700;
            color: var(--text-primary);
            font-variant-numeric: tabular-nums;
            line-height: 1;
            letter-spacing: -1px;
            font-family: "SF Pro Rounded";
            text-shadow: 0 0 20px rgba(164, 255, 0, 0.15);
        }
        .timer-label {
            font-size: 1rem;
            color: var(--fitness-green);
            text-transform: uppercase;
            font-weight: 700;
            margin-top: 5px;
            letter-spacing: 1px;
            opacity: 0.9;
        }

        .controls { display: flex; align-items: center; gap: 40px; margin-bottom: 20px; z-index: 10; }
        
        .btn-round {
            width: 75px; height: 75px; border-radius: 50%; border: none;
            font-size: 1.6rem; display: flex; justify-content: center; align-items: center;
            cursor: pointer; transition: transform 0.1s;
            backdrop-filter: blur(10px);
        }
        .btn-round:active { transform: scale(0.95); opacity: 0.8; }
        
        .start-btn { background-color: var(--fitness-green); color: #000; box-shadow: 0 0 20px rgba(164, 255, 0, 0.3); }
        .stop-btn { background-color: var(--fitness-red); color: #fff; box-shadow: 0 0 20px rgba(250, 17, 79, 0.3); }
        .reset-btn { background-color: rgba(60, 60, 65, 0.4); color: var(--text-primary); width: 50px; height: 50px; font-size: 1rem; border: 1px solid rgba(255,255,255,0.1); }

        .session-stats {
            width: 100%;
            display: flex;
            justify-content: space-around;
            padding-top: 10px;
        }
        .s-stat { text-align: center; }
        .s-val { font-size: 1.4rem; font-weight: 700; color: var(--text-primary); font-family: "SF Pro Rounded", sans-serif; }
        .s-lbl { font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }

        /* CALENDAR ACTIVITY GRID */
        .calendar-card {
            padding: 20px;
            margin-top: 15px;
            margin-left: 5px; margin-right: 5px;
        }
        .calendar-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; color: var(--text-primary); font-weight: 700; font-size: 1.1rem;
        }
        .cal-nav-btn {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: var(--fitness-green);
            width: 32px; height: 32px; border-radius: 50%;
            font-size: 1.2rem; cursor: pointer; display: flex; justify-content: center; align-items: center; padding-bottom: 3px;
        }
        .calendar-days-header {
            display: grid; grid-template-columns: repeat(7, 1fr); margin-bottom: 10px; text-align: center;
        }
        .calendar-days-header span { font-size: 0.7rem; color: var(--text-secondary); font-weight: 600; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .cal-day-cell { display: flex; justify-content: center; align-items: center; }
        .cal-ring-container {
            width: 100%; aspect-ratio: 1; position: relative;
            display: flex; justify-content: center; align-items: center;
        }
        .cal-day-num { position: absolute; font-size: 0.75rem; color: var(--text-secondary); font-weight: 500; }

        .technique-list li {
            margin-bottom: 12px; padding-left: 20px; position: relative;
            color: var(--text-secondary); font-size: 0.95rem;
        }
        .technique-list li::before { content: '‚úì'; color: var(--fitness-green); position: absolute; left: 0; font-weight: bold; }

        /* TRACKER & DATE RANGE */
        .date-range-container {
            display: flex; gap: 15px; margin-bottom: 20px;
            padding: 15px 20px;
            justify-content: space-between;
            align-items: center;
            margin-left: 5px; margin-right: 5px;
        }
        .date-input-group { display: flex; flex-direction: column; flex: 1; }
        .date-input-group label { font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; }
        .date-input {
            background: transparent; border: none; color: var(--fitness-green);
            padding: 0; font-family: inherit; font-size: 1.1rem; font-weight: 600;
            width: 100%; -webkit-appearance: none;
        }
        .date-input::-webkit-calendar-picker-indicator {
            filter: invert(1); opacity: 0.5;
        }
        
        .reset-date-btn {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: var(--text-secondary);
            border-radius: 50%; width: 36px; height: 36px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: opacity 0.2s;
        }
        .reset-date-btn:active { background: rgba(255,255,255,0.15); }

        /* CHART CONTAINER */
        .chart-wrapper {
            padding: 15px;
            margin-bottom: 20px;
            height: 250px;
            position: relative;
            margin-left: 5px; margin-right: 5px;
        }

        /* UPDATED TRACKER LIST (iOS Style) */
        .tracker-grid {
            display: flex;
            flex-direction: column;
            padding: 0; 
            overflow: hidden; 
            gap: 0; 
            margin-left: 5px; margin-right: 5px;
        }
        
        .tracker-cell {
            background-color: transparent; 
            padding: 16px 20px;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            border-bottom: 0.5px solid var(--divider);
            position: relative;
        }
        .tracker-cell:last-child {
            border-bottom: none;
        }
        .tracker-cell:active {
            background-color: rgba(255,255,255,0.05); 
        }

        .tracker-date {
            font-size: 1rem;
            color: var(--text-primary);
            font-weight: 500;
            margin: 0;
            flex: 1; 
            text-align: left;
        }

        .tracker-input-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .tracker-input {
            width: 80px;
            background: transparent;
            border: none;
            color: white; 
            font-size: 1.1rem;
            font-weight: 600;
            text-align: right;
            margin: 0;
            padding: 0;
            font-family: "SF Pro Rounded";
        }
        /* Remove spinner on number input */
        .tracker-input::-webkit-outer-spin-button,
        .tracker-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .tracker-input:focus {
            background: rgba(164, 255, 0, 0.1);
            border-radius: 4px;
            outline: none;
            color: var(--fitness-green);
        }
        .tracker-input::placeholder {
            color: #3a3a3c;
        }

        .diff-badge {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 12px;
            min-width: 50px;
            text-align: center;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }
        .diff-loss { color: #000; background-color: var(--fitness-green); }
        .diff-gain { color: #fff; background-color: var(--fitness-red); }
        .diff-neutral { color: var(--text-secondary); background: rgba(255,255,255,0.1); }


        /* BOTTOM NAVIGATION (Floating Glass Pill) */
        .bottom-nav {
            position: fixed;
            bottom: max(20px, env(safe-area-inset-bottom));
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 380px;
            background: rgba(35, 35, 35, 0.65); /* Darker glass */
            backdrop-filter: blur(35px);
            -webkit-backdrop-filter: blur(35px);
            border: 1px solid rgba(255,255,255,0.12);
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
            border-radius: 40px; /* Pill Shape */
            display: flex; justify-content: space-evenly;
            align-items: center;
            padding: 12px 20px;
            z-index: 1000;
        }

        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; 
            color: rgba(255, 255, 255, 0.4); /* Dim inactive state */
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            cursor: pointer; 
            -webkit-tap-highlight-color: transparent;
            width: 60px;
            position: relative;
        }
        
        .nav-item.active { color: #ffffff; }
        
        .nav-icon {
            width: 26px; height: 26px; 
            margin-bottom: 4px; 
            fill: currentColor;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }
        
        .nav-item.active .nav-icon { 
            transform: translateY(-2px) scale(1.1); 
            fill: var(--fitness-green); 
            filter: drop-shadow(0 0 12px rgba(164, 255, 0, 0.6)); /* Neon Glow */
        } 
        
        /* Removed Active Indicator Dot */

        .nav-label { 
            font-size: 10px; 
            font-weight: 600; 
            letter-spacing: 0.3px; 
            opacity: 0.8;
        }
        .nav-item.active .nav-label {
            opacity: 1;
            font-weight: 700;
        }

        /* CELEBRATION MODAL */
        .award-modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(20px);
            z-index: 3000;
            display: none;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }
        .award-modal.active { display: flex; }
        .award-content {
            background: rgba(28, 28, 30, 0.85);
            backdrop-filter: blur(30px);
            padding: 40px 30px;
            border-radius: 30px;
            text-align: center;
            border: 1px solid rgba(164, 255, 0, 0.3);
            box-shadow: 0 0 50px rgba(164, 255, 0, 0.15);
            transform: scale(0.9);
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            max-width: 90%;
        }
        @keyframes popIn { to { transform: scale(1); } }
        
        .award-icon { font-size: 80px; margin-bottom: 10px; display: block; animation: bounce 1.5s infinite; filter: drop-shadow(0 0 10px rgba(164,255,0,0.4)); }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        
        .award-content h2 { color: #a4ff00; font-size: 2rem; margin: 0 0 10px 0; font-weight: 800; letter-spacing: -1px; }
        .award-content p { color: #fff; margin-bottom: 30px; font-size: 1.1rem; }
        .award-close-btn {
            background: #a4ff00; color: #000; border: none;
            padding: 15px 40px; border-radius: 30px; font-weight: 700;
            font-size: 1.1rem; cursor: pointer; transition: transform 0.1s;
        }
        .award-close-btn:active { transform: scale(0.95); }

        /* iOS INSTALL PROMPT */
        .ios-prompt {
            display: none; position: fixed; bottom: 100px; left: 20px; right: 20px;
            background: rgba(28, 28, 30, 0.85); backdrop-filter: blur(20px);
            padding: 20px; border-radius: 20px; border: 1px solid var(--divider);
            z-index: 2000; animation: slideUp 0.5s ease-out;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .save-status {
            position: fixed; top: 20px; right: 20px;
            background: rgba(46, 125, 50, 0.8); backdrop-filter: blur(10px); color: white;
            padding: 8px 16px; border-radius: 20px; font-size: 0.8rem;
            font-weight: bold; opacity: 0; transition: opacity 0.5s; pointer-events: none; z-index: 2000;
        }
        .save-status.visible { opacity: 1; }

    </style>
</head>
<body>

<div class="app-content">

    <!-- VIEW: DIET PLAN -->
    <div id="view-diet" class="view-section active">
        <header>
            <h1>Diet Plan</h1>
            <h2>30-Day Aggressive Cut</h2>
        </header>

        <div class="summary-grid">
            <div class="stat-card glass-panel">
                <span class="stat-value" style="color: var(--fitness-cyan)">16:8</span>
                <span class="stat-label">Fasting</span>
            </div>
            <div class="stat-card glass-panel">
                <span class="stat-value" style="color: var(--fitness-red)">1200</span>
                <span class="stat-label">Calories</span>
            </div>
            <div class="stat-card glass-panel">
                <span class="stat-value" style="color: var(--fitness-green)">Millets</span>
                <span class="stat-label">Carbs</span>
            </div>
            <div class="stat-card glass-panel">
                <span class="stat-value" style="color: var(--fitness-orange)">Whole</span>
                <span class="stat-label">Food Only</span>
            </div>
        </div>

        <h3 class="section-title">Nutrition Insights</h3>
        <div class="protocol-grid">
            <div class="info-card glass-panel">
                <h4>üåæ Why Millets?</h4>
                <p><strong>Low GI:</strong> Prevents insulin spikes, forcing fat burn.</p>
                <p><strong>Satiety:</strong> Keeps you full for 4-5 hours.</p>
            </div>
            <div class="info-card glass-panel">
                <h4>üìä Nutrient Density</h4>
                <p><strong>Ragi:</strong> Calcium.</p>
                <p><strong>Bajra:</strong> Iron.</p>
                <p><strong>Jowar:</strong> Gut health.</p>
            </div>
        </div>

        <h3 class="section-title">Weekly Schedule</h3>
        <div class="days-container">
            <!-- Sunday -->
            <div class="day-card glass-panel" onclick="openDayModal(this)">
                <div class="day-header">
                    <span class="day-name">Sunday</span>
                    <div class="day-stats">
                        <span class="stat-badge stat-cals">1200 kcal</span>
                        <span class="stat-badge stat-prot">65g Prot</span>
                    </div>
                </div>
                <div class="meal-row">
                    <div class="meal-title">12:00 PM - Break Fast</div>
                    <div class="meal-content"><strong>2 Small Ragi Rotis</strong> + 120g Paneer Bhurji + 100g Cucumber.</div>
                    <div class="badges-wrapper"><span class="badge badge-cal">~480 kcal</span><span class="badge badge-millet">Calcium</span></div>
                </div>
                <div class="meal-row">
                    <div class="meal-title">4:00 PM - Snack</div>
                    <div class="meal-content"><strong>Spiced Soya Chunks</strong> (40g dry wt, boiled & saut√©ed).</div>
                    <div class="badges-wrapper"><span class="badge badge-cal">~180 kcal</span></div>
                </div>
                <div class="meal-row">
                    <div class="meal-title">7:30 PM - Dinner</div>
                    <div class="meal-content"><strong>Grilled Tofu Salad</strong> (150g Tofu + 50g Veggies).</div>
                    <div class="badges-wrapper"><span class="badge badge-cal">~320 kcal</span></div>
                </div>
            </div>

            <!-- Monday -->
            <div class="day-card glass-panel" onclick="openDayModal(this)">
                <div class="day-header">
                    <span class="day-name">Monday</span>
                    <div class="day-stats">
                        <span class="stat-badge stat-cals">1180 kcal</span>
                        <span class="stat-badge stat-prot">50g Prot</span>
                    </div>
                </div>
                <div class="meal-row">
                    <div class="meal-title">12:00 PM - Break Fast</div>
                    <div class="meal-content"><strong>Foxtail Millet</strong> (100g Cooked) + 200g Rajma Masala + 100g Green Salad.</div>
                    <div class="badges-wrapper"><span class="badge badge-cal">~400 kcal</span><span class="badge badge-millet">Low GI</span></div>
                </div>
                <div class="meal-row">
                    <div class="meal-title">4:00 PM - Snack</div>
                    <div class="meal-content">150g Greek Yogurt + 10g Chia Seeds.</div>
                    <div class="badges-wrapper"><span class="badge badge-cal">~140 kcal</span></div>
                </div>
                <div class="meal-row">
                    <div class="meal-title">7:30 PM - Dinner</div>
                    <div class="meal-content">300ml Spinach Soup + <strong>120g Saut√©ed Paneer</strong>.</div>
                    <div class="badges-wrapper"><span class="badge badge-cal">~370 kcal</span></div>
                </div>
            </div>

             <!-- Tuesday -->
            <div class="day-card glass-panel" onclick="openDayModal(this)">
                <div class="day-header">
                    <span class="day-name">Tuesday</span>
                    <div class="day-stats">
                        <span class="stat-badge stat-cals">1200 kcal</span>
                        <span class="stat-badge stat-prot">70g Prot</span>
                    </div>
                </div>
                <div class="meal-row">
                    <div class="meal-title">12:00 PM - Break Fast</div>
                    <div class="meal-content"><strong>2 Jowar Rotis</strong> + Soya Chunk Curry (50g dry wt).</div>
                    <div class="badges-wrapper"><span class="badge badge-cal">~400 kcal</span></div>
                </div>
                <div class="meal-row">
                    <div class="meal-title">4:00 PM - Snack</div>
                    <div class="meal-content"><strong>Grilled Tofu Cubes</strong> (100g) with Lemon.</div>
                    <div class="badges-wrapper"><span class="badge badge-cal">~140 kcal</span></div>
                </div>
                <div class="meal-row">
                    <div class="meal-title">7:30 PM - Dinner</div>
                    <div class="meal-content"><strong>Warm Soya Salad</strong> (50g dry wt Soya + 100g Veggies).</div>
                    <div class="badges-wrapper"><span class="badge badge-cal">~250 kcal</span></div>
                </div>
            </div>

            <!-- Wednesday -->
            <div class="day-card glass-panel" onclick="openDayModal(this)">
                <div class="day-header">
                    <span class="day-name">Wednesday</span>
                    <div class="day-stats">
                        <span class="stat-badge stat-cals">1220 kcal</span>
                        <span class="stat-badge stat-prot">55g Prot</span>
                    </div>
                </div>
                <div class="meal-row">
                    <div class="meal-title">12:00 PM - Break Fast</div>
                    <div class="meal-content">2 Besan Chillas + <strong>80g Paneer Stuffing</strong>.</div>
                    <div class="badges-wrapper"><span class="badge badge-cal">~440 kcal</span></div>
                </div>
                <div class="meal-row">
                    <div class="meal-title">4:00 PM - Snack</div>
                    <div class="meal-content">100g Sprouted Moong Salad.</div>
                    <div class="badges-wrapper"><span class="badge badge-cal">~120 kcal</span></div>
                </div>
                <div class="meal-row">
                    <div class="meal-title">7:30 PM - Dinner</div>
                    <div class="meal-content">150g Stir-fry Veggies + <strong>150g Grilled Tofu</strong>.</div>
                    <div class="badges-wrapper"><span class="badge badge-cal">~320 kcal</span></div>
                </div>
            </div>

            <!-- Thursday -->
            <div class="day-card glass-panel" onclick="openDayModal(this)">
                <div class="day-header">
                    <span class="day-name">Thursday</span>
                    <div class="day-stats">
                        <span class="stat-badge stat-cals">1200 kcal</span>
                        <span class="stat-badge stat-prot">45g Prot</span>
                    </div>
                </div>
                <div class="meal-row">
                    <div class="meal-title">12:00 PM - Break Fast</div>
                    <div class="meal-content"><strong>Barnyard Millet Khichdi</strong> (200g) + 100g Saut√©ed Spinach.</div>
                    <div class="badges-wrapper"><span class="badge badge-cal">~350 kcal</span><span class="badge badge-millet">Fiber Rich</span></div>
                </div>
                <div class="meal-row">
                    <div class="meal-title">4:00 PM - Snack</div>
                    <div class="meal-content"><strong>50g Roasted Black Chana</strong>.</div>
                    <div class="badges-wrapper"><span class="badge badge-cal">~180 kcal</span></div>
                </div>
                <div class="meal-row">
                    <div class="meal-title">7:30 PM - Dinner</div>
                    <div class="meal-content"><strong>Papaya (100g) & Cucumber (100g) Salad</strong> + 100g Paneer.</div>
                    <div class="badges-wrapper"><span class="badge badge-cal">~320 kcal</span></div>
                </div>
            </div>

            <!-- Friday -->
            <div class="day-card glass-panel" onclick="openDayModal(this)">
                <div class="day-header">
                    <span class="day-name">Friday</span>
                    <div class="day-stats">
                        <span class="stat-badge stat-cals">1250 kcal</span>
                        <span class="stat-badge stat-prot">45g Prot</span>
                    </div>
                </div>
                <div class="meal-row">
                    <div class="meal-title">12:00 PM - Break Fast</div>
                    <div class="meal-content"><strong>2 Bajra Rotis</strong> + Palak Paneer (120g Paneer).</div>
                    <div class="badges-wrapper"><span class="badge badge-cal">~550 kcal</span><span class="badge badge-protein">Protein Rich</span></div>
                </div>
                <div class="meal-row">
                    <div class="meal-title">4:00 PM - Snack</div>
                    <div class="meal-content">30g Roasted Makhana.</div>
                    <div class="badges-wrapper"><span class="badge badge-cal">~100 kcal</span></div>
                </div>
                <div class="meal-row">
                    <div class="meal-title">7:30 PM - Dinner</div>
                    <div class="meal-content"><strong>High Protein Chana Salad</strong> (100g Boiled Chana + 100g Veggies + 100g Curd).</div>
                    <div class="badges-wrapper"><span class="badge badge-cal">~250 kcal</span></div>
                </div>
            </div>

            <!-- Saturday -->
            <div class="day-card glass-panel" onclick="openDayModal(this)">
                <div class="day-header">
                    <span class="day-name">Saturday</span>
                    <div class="day-stats">
                        <span class="stat-badge stat-cals">1250 kcal</span>
                        <span class="stat-badge stat-prot">55g Prot</span>
                    </div>
                </div>
                <div class="meal-row">
                    <div class="meal-title">12:00 PM - Break Fast</div>
                    <div class="meal-content"><strong>Little Millet</strong> (100g Cooked) + 200g Chole Curry.</div>
                    <div class="badges-wrapper"><span class="badge badge-cal">~350 kcal</span></div>
                </div>
                <div class="meal-row">
                    <div class="meal-title">4:00 PM - Snack</div>
                    <div class="meal-content"><strong>Saut√©ed Tofu</strong> (100g) with Garlic & Herbs.</div>
                    <div class="badges-wrapper"><span class="badge badge-cal">~140 kcal</span></div>
                </div>
                <div class="meal-row">
                    <div class="meal-title">7:30 PM - Dinner</div>
                    <div class="meal-content"><strong>Paneer Tikka</strong> (120g Paneer + 50g Veggies).</div>
                    <div class="badges-wrapper"><span class="badge badge-cal">~350 kcal</span><span class="badge badge-protein">Cheat Meal Feel</span></div>
                </div>
            </div>
        </div>

        <h3 class="section-title">Guidelines</h3>
        <div class="info-card glass-panel" style="border: 1px solid rgba(250, 17, 79, 0.3); background: rgba(250, 17, 79, 0.1);">
            <strong>‚ö†Ô∏è 1200 kcal Warning</strong>
            <p>This is a low-calorie intake. If dizzy, add a fruit. Eat unlimited cucumbers.</p>
        </div>
    </div>

    <!-- VIEW: WORKOUT (TIMER) -->
    <div id="view-workout" class="view-section">
        <header>
            <h1>Workout</h1>
            <h2>Brisk Walking</h2>
        </header>

        <div class="walking-tool-card glass-panel">
            <!-- Progress Ring -->
            <div class="ring-container">
                <svg class="progress-ring" width="260" height="260">
                    <circle class="progress-ring__circle-bg" stroke="#1c1c1e" stroke-width="18" fill="transparent" r="110" cx="130" cy="130"/>
                    <circle class="progress-ring__circle" id="timer-ring" stroke-dasharray="691 691" stroke-dashoffset="0" stroke-width="18" fill="transparent" r="110" cx="130" cy="130"/>
                </svg>
                <div class="timer-value-container">
                    <div class="timer-display" id="walk-timer">45:00</div>
                    <div class="timer-label">Remaining</div>
                </div>
            </div>
            
            <div class="controls">
                <button class="btn-round reset-btn" onclick="resetWalk()">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                </button>
                <button class="btn-round start-btn" id="toggle-btn" onclick="toggleTimer()">
                    <svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                </button>
            </div>

            <div class="session-stats">
                <div class="s-stat">
                    <span class="s-val" id="est-cals" style="color: var(--fitness-red);">0</span>
                    <span class="s-lbl">KCAL</span>
                </div>
                <div class="s-stat">
                    <span class="s-val" style="color: var(--fitness-green);">45</span>
                    <span class="s-lbl">GOAL</span>
                </div>
            </div>
        </div>

        <h3 class="section-title">Technique</h3>
        <div class="info-card glass-panel">
            <ul class="technique-list">
                <li><strong>Posture:</strong> Tall spine, eyes forward.</li>
                <li><strong>Arms:</strong> Bent 90¬∞, swing from shoulders.</li>
                <li><strong>Strike:</strong> Heel to toe roll.</li>
                <li><strong>Target:</strong> 45 Mins Daily (Morning).</li>
            </ul>
        </div>

        <h3 class="section-title">Activity Calendar</h3>
        <div class="calendar-card glass-panel">
            <div class="calendar-header">
                <button class="cal-nav-btn" onclick="changeMonth(-1)">‚Äπ</button>
                <span id="cal-month-year"></span>
                <button class="cal-nav-btn" onclick="changeMonth(1)">‚Ä∫</button>
            </div>
            <div class="calendar-days-header">
                <span>S</span><span>M</span><span>T</span><span>W</span><span>T</span><span>F</span><span>S</span>
            </div>
            <div class="calendar-grid" id="activity-grid">
                <!-- Grid items generated by JS -->
            </div>
        </div>
    </div>

    <!-- VIEW: TRACKER (WEIGHT) -->
    <div id="view-tracker" class="view-section">
        <header>
            <h1>Progress</h1>
            <h2>Weight Log</h2>
        </header>

        <div class="date-range-container glass-panel">
            <div class="date-input-group">
                <label>Start Date</label>
                <input type="date" id="tracker-start" class="date-input">
            </div>
            <div class="date-input-group">
                <label>End Date</label>
                <input type="date" id="tracker-end" class="date-input">
            </div>
            <button class="reset-date-btn" onclick="resetDates()" title="Reset Range">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
            </button>
        </div>

        <div class="chart-wrapper glass-panel">
            <canvas id="weightChart"></canvas>
        </div>

        <div id="tracker-container" class="tracker-grid glass-panel">
            <!-- JS Populated -->
        </div>
    </div>

</div>

<!-- BOTTOM NAVIGATION (Floating Glass Pill) -->
<nav class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('diet', this)">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
        </svg>
        <span class="nav-label">Plan</span>
    </div>
    <div class="nav-item" onclick="switchTab('workout', this)">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M13.5 5.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM9.8 8.9L7 23h2.1l1.8-8 2.1 2v6h2v-7.5l-2.1-2 .6-3C14.8 12 16.8 13 19 13v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.4-.6-1-1-1.7-1-.3 0-.5.1-.8.1L6 8.3V13h2V9.6l1.8-.7z"/>
        </svg>
        <span class="nav-label">Workout</span>
    </div>
    <div class="nav-item" onclick="switchTab('tracker', this)">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/>
        </svg>
        <span class="nav-label">Progress</span>
    </div>
</nav>

<!-- CELEBRATION MODAL -->
<div id="award-modal" class="award-modal">
    <div class="award-content">
        <div class="award-icon">üèÜ</div>
        <h2>Goal Crushed!</h2>
        <p>You completed 45 minutes of brisk walking.</p>
        <button class="award-close-btn" onclick="closeAward()">Awesome!</button>
    </div>
</div>

<!-- FULL SCREEN DAY MODAL (UPDATED TO SHEET) -->
<div id="day-modal" class="day-modal">
    <div class="modal-sheet">
        <div class="modal-handle-container">
            <div class="modal-handle"></div>
        </div>
        <div class="modal-header-bar">
            <div id="modal-day-title" class="modal-day-title">Monday</div>
            <button class="modal-close-btn" onclick="closeDayModal()">‚úï</button>
        </div>
        <div id="modal-body-content" class="modal-body-content">
            <!-- Content Injected Here -->
        </div>
    </div>
</div>

<!-- UTILS -->
<div id="ios-install-prompt" class="ios-prompt">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
        <strong>Install App</strong>
        <span onclick="document.getElementById('ios-install-prompt').style.display='none'">‚úï</span>
    </div>
    <p>1. Tap <strong>Share</strong> button <br> 2. Tap <strong>Add to Home Screen</strong></p>
</div>

<div id="save-status" class="save-status">‚úì Saved</div>

<script>
    // --- TAB NAVIGATION ---
    function switchTab(tabId, element) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById('view-' + tabId).classList.add('active');
        element.classList.add('active');
        document.querySelector('.app-content').scrollTop = 0;
    }

    // --- DAY MODAL LOGIC (New) ---
    function openDayModal(card) {
        const modal = document.getElementById('day-modal');
        const dayName = card.querySelector('.day-name').innerText;
        const mealRows = card.querySelectorAll('.meal-row');
        
        document.getElementById('modal-day-title').innerText = dayName;
        
        let contentHtml = '';
        mealRows.forEach(row => {
            const title = row.querySelector('.meal-title').innerText;
            const content = row.querySelector('.meal-content').innerHTML;
            const badges = row.querySelector('.badges-wrapper') ? row.querySelector('.badges-wrapper').outerHTML : '';
            
            contentHtml += `
                <div class="modal-meal-row">
                    <div class="modal-meal-type">${title}</div>
                    <div class="modal-meal-desc">${content}</div>
                    <div class="modal-badges-wrapper">${badges}</div>
                </div>
            `;
        });
        
        document.getElementById('modal-body-content').innerHTML = contentHtml;
        modal.classList.add('active');
        document.body.style.overflow = 'hidden'; // Lock scroll
    }

    function closeDayModal() {
        document.getElementById('day-modal').classList.remove('active');
        document.body.style.overflow = ''; // Unlock scroll
    }

    // --- TIMER LOGIC (COUNTDOWN + RING + ALARM) ---
    const GOAL_MINUTES = 45;
    const GOAL_MS = GOAL_MINUTES * 60 * 1000;
    const ALARM_INTERVAL_MS = 5 * 60 * 1000; // 5 mins

    // Keys
    const KEY_TARGET_END = 'walkTargetEnd';     // When the timer is scheduled to finish (timestamp)
    const KEY_REMAINING = 'walkRemaining';      // Saved remaining ms when paused
    const KEY_IS_RUNNING = 'walkIsRunning';
    const KEY_LAST_BEEP = 'walkLastBeepMin';    // Track last beep minute to avoid double triggers
    const KEY_ACTIVITY_LOG = 'walkActivityLog'; // { "YYYY-MM-DD": minutes }

    // Init Calendar View Date (Must be defined before usage)
    let calendarViewDate = new Date();

    let timerInterval;
    const timerDisplay = document.getElementById('walk-timer');
    const toggleBtn = document.getElementById('toggle-btn');
    const calsDisplay = document.getElementById('est-cals');
    const ringCircle = document.getElementById('timer-ring');
    
    // SVG Config
    const radius = ringCircle.r.baseVal.value;
    const circumference = radius * 2 * Math.PI;
    ringCircle.style.strokeDasharray = `${circumference} ${circumference}`;
    ringCircle.style.strokeDashoffset = circumference; 

    function setProgress(percent) {
        const offset = circumference - (percent / 100) * circumference;
        ringCircle.style.strokeDashoffset = offset;
    }

    // Audio Engine - GLOBAL CONTEXT FOR IOS
    let audioCtx; // Persistent audio context

    function playBeep() {
        // Safe check
        if (!audioCtx) return;

        const t = audioCtx.currentTime;
        
        // Helper function to create a single tone
        function playTone(freq, startTime, duration) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            osc.frequency.value = freq;
            osc.type = 'sine'; // Smooth sine wave
            
            // Volume Envelope (Fade in/out to prevent clicking)
            gain.gain.setValueAtTime(0, startTime);
            gain.gain.linearRampToValueAtTime(0.2, startTime + 0.05); // Attack
            gain.gain.setValueAtTime(0.2, startTime + duration - 0.05); // Sustain
            gain.gain.linearRampToValueAtTime(0, startTime + duration); // Release
            
            osc.start(startTime);
            osc.stop(startTime + duration);
        }

        // 3+ Second Alarm Sequence: Beep... Beep... Beep... BEEEEEP!
        playTone(880, t, 0.6);        // Tone 1 (0.0s - 0.6s)
        playTone(880, t + 0.8, 0.6);  // Tone 2 (0.8s - 1.4s)
        playTone(880, t + 1.6, 0.6);  // Tone 3 (1.6s - 2.2s)
        playTone(1760, t + 2.4, 1.0); // Final High Tone (2.4s - 3.4s)
    }

    // CELEBRATION LOGIC
    function showAward() {
        // Launch Confetti
        confetti({
            particleCount: 150,
            spread: 70,
            origin: { y: 0.6 },
            colors: ['#a4ff00', '#ffffff'] // Neon green & white
        });

        // Show Modal
        document.getElementById('award-modal').classList.add('active');

        // Play Victory Sound (Major Arpeggio)
        if(audioCtx) {
            const t = audioCtx.currentTime;
            const playNote = (f, s) => {
                const osc = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                osc.connect(g); g.connect(audioCtx.destination);
                osc.frequency.value = f;
                g.gain.setValueAtTime(0.1, s);
                g.gain.exponentialRampToValueAtTime(0.001, s + 0.5);
                osc.start(s); osc.stop(s + 0.5);
            };
            playNote(523.25, t);       // C5
            playNote(659.25, t + 0.1); // E5
            playNote(783.99, t + 0.2); // G5
            playNote(1046.50, t + 0.3); // C6
        }
    }

    function closeAward() {
        document.getElementById('award-modal').classList.remove('active');
    }

    initTimer();

    function initTimer() {
        const isRunning = localStorage.getItem(KEY_IS_RUNNING) === 'true';
        if (isRunning) {
            setBtnStop();
            timerInterval = setInterval(updateTimerLoop, 1000);
        } else {
            setBtnStart();
        }
        updateTimerVisuals(); // Immediate render
        renderCalendar(); // New Calendar Function
    }

    function toggleTimer() {
        const isRunning = localStorage.getItem(KEY_IS_RUNNING) === 'true';
        
        // Initialize Audio Context on user gesture (ESSENTIAL FOR iOS)
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        // Always try to resume context on user interaction
        if (audioCtx.state === 'suspended') {
            audioCtx.resume();
        }

        if (isRunning) {
            // PAUSE
            clearInterval(timerInterval);
            const targetEnd = parseInt(localStorage.getItem(KEY_TARGET_END) || 0);
            const remaining = Math.max(0, targetEnd - Date.now());
            
            localStorage.setItem(KEY_REMAINING, remaining);
            localStorage.setItem(KEY_IS_RUNNING, 'false');
            localStorage.removeItem(KEY_TARGET_END);
            
            logDailyActivity(remaining); // Save progress
            setBtnStart();
            updateTimerVisuals();
        } else {
            // START
            const currentRemaining = parseInt(localStorage.getItem(KEY_REMAINING));
            // Default to goal if not set or finished
            const duration = (!isNaN(currentRemaining) && currentRemaining > 0) ? currentRemaining : GOAL_MS;
            
            localStorage.setItem(KEY_TARGET_END, Date.now() + duration);
            localStorage.setItem(KEY_IS_RUNNING, 'true');
            
            timerInterval = setInterval(updateTimerLoop, 1000);
            setBtnStop();
        }
    }

    function updateTimerLoop() {
        const targetEnd = parseInt(localStorage.getItem(KEY_TARGET_END) || 0);
        const remaining = targetEnd - Date.now();

        if (remaining <= 0) {
            // Finished
            clearInterval(timerInterval);
            localStorage.setItem(KEY_IS_RUNNING, 'false');
            localStorage.setItem(KEY_REMAINING, 0);
            localStorage.removeItem(KEY_TARGET_END);
            
            logDailyActivity(0); // Log complete (0 remaining)
            showAward(); // TRIGGER CELEBRATION
            
            setBtnStart();
            updateTimerVisuals();
            return;
        }

        // Alarm Logic (Every 5 mins i.e., when passed 40, 35, 30...)
        const elapsedMinutes = (GOAL_MS - remaining) / 1000 / 60;
        const currentBlock = Math.floor(elapsedMinutes / 5); 
        const lastBlock = parseInt(localStorage.getItem(KEY_LAST_BEEP) || 0);

        if (currentBlock > lastBlock && currentBlock > 0) {
            playBeep();
            localStorage.setItem(KEY_LAST_BEEP, currentBlock);
        }

        updateTimerVisuals(remaining);
        
        // Auto-save progress every minute (optional but good for crash recovery)
        if (Math.floor(Date.now() / 1000) % 60 === 0) {
             logDailyActivity(remaining);
        }
    }

    function updateTimerVisuals(forceRemaining) {
        let remaining;
        
        if (forceRemaining !== undefined) {
            remaining = forceRemaining;
        } else if (localStorage.getItem(KEY_IS_RUNNING) === 'true') {
            const targetEnd = parseInt(localStorage.getItem(KEY_TARGET_END) || 0);
            remaining = Math.max(0, targetEnd - Date.now());
        } else {
            const saved = parseInt(localStorage.getItem(KEY_REMAINING));
            remaining = !isNaN(saved) ? saved : GOAL_MS;
        }

        // Format Time
        const totalSec = Math.ceil(remaining / 1000);
        const mins = Math.floor(totalSec / 60);
        const secs = totalSec % 60;
        timerDisplay.textContent = `${pad(mins)}:${pad(secs)}`;

        // Calories (Estimate based on completed time)
        const completedMinutes = (GOAL_MS - remaining) / 1000 / 60;
        calsDisplay.textContent = Math.floor(completedMinutes * 8.5);

        // Ring Progress
        // 45:00 remaining = 0% progress. 00:00 remaining = 100% progress.
        const percent = ((GOAL_MS - remaining) / GOAL_MS) * 100;
        setProgress(percent);
    }

    function logDailyActivity(remainingMs) {
        const completedMs = GOAL_MS - remainingMs;
        const mins = completedMs / 1000 / 60;
        
        // Use YYYY-MM-DD as key
        const todayKey = new Date().toISOString().split('T')[0];
        
        let log = JSON.parse(localStorage.getItem(KEY_ACTIVITY_LOG) || '{}');
        
        // Only update if current session is more (e.g. didn't reset)
        // Or strictly add up sessions? For simplicity, let's say "Max achieved today"
        // Or if you want cumulative: log[todayKey] = (log[todayKey] || 0) + sessionDiff... too complex for now.
        // Let's assume the timer represents "Today's Walk".
        log[todayKey] = Math.max(log[todayKey] || 0, mins); 
        
        localStorage.setItem(KEY_ACTIVITY_LOG, JSON.stringify(log));
        renderCalendar();
    }

    function resetWalk() {
        clearInterval(timerInterval);
        localStorage.removeItem(KEY_TARGET_END);
        localStorage.removeItem(KEY_IS_RUNNING);
        localStorage.removeItem(KEY_LAST_BEEP);
        localStorage.setItem(KEY_REMAINING, GOAL_MS); // Reset to full 45
        
        setBtnStart();
        updateTimerVisuals();
        setProgress(0);
    }

    // --- ACTIVITY CALENDAR RENDERER ---
    function changeMonth(offset) {
        calendarViewDate.setMonth(calendarViewDate.getMonth() + offset);
        renderCalendar();
    }

    function renderCalendar() {
        const grid = document.getElementById('activity-grid');
        const monthLabel = document.getElementById('cal-month-year');
        if(!grid) return;

        grid.innerHTML = '';
        const year = calendarViewDate.getFullYear();
        const month = calendarViewDate.getMonth();
        
        monthLabel.textContent = calendarViewDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

        const firstDayIndex = new Date(year, month, 1).getDay(); // 0 = Sunday
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        const activityLog = JSON.parse(localStorage.getItem(KEY_ACTIVITY_LOG) || '{}');

        // Empty cells for days before the 1st
        for (let i = 0; i < firstDayIndex; i++) {
            const cell = document.createElement('div');
            cell.className = 'cal-day-cell empty';
            grid.appendChild(cell);
        }

        // Days
        for (let i = 1; i <= daysInMonth; i++) {
            // Construct YYYY-MM-DD key manually to avoid timezone issues
            const m = String(month + 1).padStart(2, '0');
            const d = String(i).padStart(2, '0');
            const safeKey = `${year}-${m}-${d}`;

            const minsDone = activityLog[safeKey] || 0;
            const percent = Math.min(100, (minsDone / 45) * 100); // 45 is goal

            const cell = document.createElement('div');
            cell.className = 'cal-day-cell';
            
            // SVG Circle for Ring
            // If < 100% show faint or red? If done show green.
            // Let's do: Green if any progress, just partial ring.
            const ringColor = '#a4ff00';
            
            // Mini Ring SVG
            const svgHtml = `
                <div class="cal-ring-container">
                    <svg width="36" height="36" viewBox="0 0 36 36">
                        <path
                            d="M18 2.0845
                                a 15.9155 15.9155 0 0 1 0 31.831
                                a 15.9155 15.9155 0 0 1 0 -31.831"
                            fill="none"
                            stroke="#2c2c2e"
                            stroke-width="3"
                        />
                        <path
                            d="M18 2.0845
                                a 15.9155 15.9155 0 0 1 0 31.831
                                a 15.9155 15.9155 0 0 1 0 -31.831"
                            fill="none"
                            stroke="${percent > 0 ? ringColor : 'none'}"
                            stroke-width="3"
                            stroke-dasharray="${percent}, 100"
                            stroke-linecap="round"
                        />
                    </svg>
                    <span class="cal-day-num">${i}</span>
                </div>
            `;
            
            cell.innerHTML = svgHtml;
            grid.appendChild(cell);
        }
    }

    function setBtnStart() { 
        toggleBtn.innerHTML = '<svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>'; 
        toggleBtn.classList.remove('stop-btn'); toggleBtn.classList.add('start-btn'); 
    }
    function setBtnStop() { 
        toggleBtn.innerHTML = '<svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>'; 
        toggleBtn.classList.remove('start-btn'); toggleBtn.classList.add('stop-btn'); 
    }
    function pad(val) { return val < 10 ? '0' + val : val; }


    // --- WEIGHT TRACKER LOGIC ---
    const container = document.getElementById('tracker-container');
    const storageKey = 'fatLossWeightTracker';
    const saveStatus = document.getElementById('save-status');
    const startInput = document.getElementById('tracker-start');
    const endInput = document.getElementById('tracker-end');

    // Default or stored range
    const today = new Date();
    const future = new Date();
    future.setDate(today.getDate() + 30);

    const storedStart = localStorage.getItem('trackerStartDate');
    const storedEnd = localStorage.getItem('trackerEndDate');

    startInput.value = storedStart || today.toISOString().split('T')[0];
    endInput.value = storedEnd || future.toISOString().split('T')[0];

    // Load data
    let savedData = JSON.parse(localStorage.getItem(storageKey)) || {};
    let inputs = [];
    let weightChart;

    // Initialize Chart
    function initChart() {
        const ctx = document.getElementById('weightChart').getContext('2d');
        
        // Create Apple Fitness style gradient
        const gradient = ctx.createLinearGradient(0, 0, 0, 300);
        gradient.addColorStop(0, 'rgba(164, 255, 0, 0.4)'); // Top: Semi-transparent Neon Green
        gradient.addColorStop(1, 'rgba(164, 255, 0, 0.0)'); // Bottom: Transparent

        Chart.defaults.color = '#8e8e93';
        Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, "SF Pro Rounded", "Segoe UI", Roboto, sans-serif';
        
        weightChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Weight',
                    data: [],
                    borderColor: '#a4ff00', // --fitness-green
                    backgroundColor: gradient,
                    borderWidth: 3,
                    pointBackgroundColor: '#000',
                    pointBorderColor: '#a4ff00',
                    pointBorderWidth: 2,
                    pointRadius: 0, // Clean look: hide points by default
                    pointHoverRadius: 6, // Show on interaction
                    pointHoverBackgroundColor: '#000',
                    pointHoverBorderColor: '#a4ff00',
                    pointHoverBorderWidth: 3,
                    fill: true,
                    tension: 0.4, // Smooth curve
                    borderCapStyle: 'round',
                    borderJoinStyle: 'round'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#1c1c1e',
                        titleColor: '#8e8e93',
                        titleFont: { size: 11, weight: '500' },
                        bodyColor: '#ffffff',
                        bodyFont: { size: 14, weight: '700', family: 'SF Pro Rounded' },
                        padding: 12,
                        cornerRadius: 12,
                        borderColor: '#2c2c2e',
                        borderWidth: 1,
                        displayColors: false,
                        callbacks: {
                            label: (ctx) => `${ctx.parsed.y} kg`
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { display: false, drawBorder: false },
                        ticks: { 
                            color: '#8e8e93',
                            font: { size: 10 },
                            maxTicksLimit: 6, 
                            maxRotation: 0 
                        },
                        border: { display: false }
                    },
                    y: {
                        grid: { 
                            color: '#2c2c2e',
                            borderDash: [5, 5],
                            drawBorder: false
                        },
                        border: { display: false },
                        ticks: {
                            color: '#8e8e93',
                            font: { size: 10 },
                            padding: 10
                        }
                    }
                }
            }
        });
    }

    function updateChart() {
        // Visualize ALL data, ignoring the start/end input range filters
        const dataPoints = [];
        const labels = [];

        // Sort keys to ensure chronological order
        const sortedKeys = Object.keys(savedData).sort();

        sortedKeys.forEach(dateStr => {
            const d = new Date(dateStr);
            const val = parseFloat(savedData[dateStr]);
            
            // Only add valid numbers
            if (!isNaN(val)) {
                // Format Label
                const label = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                labels.push(label);
                dataPoints.push(val);
            }
        });

        weightChart.data.labels = labels;
        weightChart.data.datasets[0].data = dataPoints;
        weightChart.update();
    }

    function renderTracker() {
        // Clear existing
        container.innerHTML = '';
        inputs = [];

        const start = new Date(startInput.value);
        const end = new Date(endInput.value);
        let current = new Date(start);

        // Sanity check
        if(isNaN(start.getTime()) || isNaN(end.getTime()) || start > end) return;

        while (current <= end) {
            const dateKey = current.toISOString().split('T')[0];
            
            const cell = document.createElement('div');
            cell.className = 'tracker-cell';

            // Left: Date
            const label = document.createElement('span');
            label.className = 'tracker-date';
            // Show "Weekday, Month Day"
            label.textContent = current.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

            // Right: Wrapper for Input + Badge
            const rightWrapper = document.createElement('div');
            rightWrapper.className = 'tracker-input-wrapper';

            const input = document.createElement('input');
            input.type = 'number';
            input.className = 'tracker-input';
            input.placeholder = '0.0'; 
            input.step = '0.1';
            input.dataset.key = dateKey;
            
            if (savedData[dateKey]) input.value = savedData[dateKey];

            const badge = document.createElement('span');
            badge.className = 'diff-badge';

            // Events
            input.addEventListener('input', (e) => {
                savedData[dateKey] = e.target.value;
                localStorage.setItem(storageKey, JSON.stringify(savedData));
                calculateDiffs();
                updateChart();
                showSave();
            });

            rightWrapper.appendChild(input);
            rightWrapper.appendChild(badge);
            
            cell.appendChild(label); 
            cell.appendChild(rightWrapper);
            
            container.appendChild(cell);
            inputs.push({ input, badge });
            
            current.setDate(current.getDate() + 1);
        }
        calculateDiffs();
        updateChart();
    }

    // Listen for date changes
    startInput.addEventListener('change', () => {
        localStorage.setItem('trackerStartDate', startInput.value);
        renderTracker();
    });
    endInput.addEventListener('change', () => {
        localStorage.setItem('trackerEndDate', endInput.value);
        renderTracker();
    });

    function resetDates() {
        // Dynamic dates for current context
        const now = new Date();
        const futureDate = new Date();
        futureDate.setDate(now.getDate() + 30);
        
        const defaultStart = now.toISOString().split('T')[0];
        const defaultEnd = futureDate.toISOString().split('T')[0];
        
        startInput.value = defaultStart;
        endInput.value = defaultEnd;
        
        // Save preferences but DO NOT clear fatLossWeightTracker data
        localStorage.setItem('trackerStartDate', defaultStart);
        localStorage.setItem('trackerEndDate', defaultEnd);
        renderTracker(); // This will re-render grid/chart with existing data for the new range
    }

    function calculateDiffs() {
        let lastVal = null;
        inputs.forEach(({ input, badge }) => {
            const val = parseFloat(input.value);
            badge.className = 'diff-badge';
            badge.textContent = '';
            
            if (!isNaN(val)) {
                if (lastVal !== null) {
                    const diff = val - lastVal;
                    badge.textContent = diff > 0 ? `+${diff.toFixed(1)}` : diff.toFixed(1);
                    badge.classList.add(diff > 0 ? 'diff-gain' : (diff < 0 ? 'diff-loss' : 'diff-neutral'));
                } else {
                    badge.textContent = 'Start';
                }
                lastVal = val;
            }
        });
    }

    function showSave() {
        saveStatus.classList.add('visible');
        setTimeout(() => saveStatus.classList.remove('visible'), 2000);
    }

    // Initial render
    initChart();
    renderTracker();

    // iOS check
    if (/iPhone|iPad/.test(navigator.userAgent) && !window.navigator.standalone) {
        setTimeout(() => document.getElementById('ios-install-prompt').style.display = 'block', 2000);
    }
</script>

</body>
</html>
